<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç½‘ç‚¹è·¯çº¿ä¼˜åŒ–ç³»ç»Ÿï¼ˆç™¾åº¦åœ°å›¾ç‰ˆï¼‰</title>

  <style>
    /* ====== è¿™é‡ŒåŸºæœ¬ç…§æ¬ä½ æä¾›æ–‡ä»¶çš„æ ·å¼ ====== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Microsoft YaHei", "PingFang SC", Arial, sans-serif; }
    #container { width: 100%; height: 100vh; }
    #control-panel {
      position: absolute; top: 20px; left: 20px; background: white;
      padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 380px; z-index: 1000; max-height: 85vh; overflow-y: auto;
    }
    h2 { margin-bottom: 15px; color: #333; font-size: 18px; }
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 13px; }
    textarea, input[type="text"], input[type="file"] {
      width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;
      font-size: 12px; font-family: inherit;
    }
    textarea { resize: vertical; }
    input[type="file"] { padding: 8px; }
    .btn {
      padding: 10px 20px; margin: 5px 5px 5px 0; border: none; border-radius: 5px;
      cursor: pointer; font-size: 13px; font-weight: bold; transition: all 0.3s;
    }
    .btn-primary { background: #3366FF; color: white; }
    .btn-primary:hover { background: #2850CC; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-success:hover { background: #388E3C; }
    .btn-clear { background: #9E9E9E; color: white; }
    .btn-clear:hover { background: #757575; }
    #route-info { margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 5px; font-size: 13px; }
    .route-item { padding: 8px; margin: 5px 0; background: white; border-left: 4px solid #3366FF; border-radius: 3px; }
    .distance-info { color: #FF5722; font-weight: bold; }
    .loading { text-align: center; color: #666; padding: 10px; }
    .error-box {
      background: #FFEBEE; padding: 10px; border-radius: 5px; margin-top: 10px;
      font-size: 12px; color: #C62828; border-left: 4px solid #F44336;
    }
    .tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid #ddd; }
    .tab {
      padding: 10px 20px; cursor: pointer; border: none; background: none;
      font-size: 14px; color: #666; transition: all 0.3s;
    }
    .tab.active { color: #3366FF; border-bottom: 3px solid #3366FF; margin-bottom: -2px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .excel-template {
      background: #E3F2FD; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px;
    }
    .excel-template code { background: white; padding: 2px 6px; border-radius: 3px; font-family: monospace; }

    /* marker åœ†ç‚¹æ ·å¼ï¼ˆç”¨DOMå åŠ ï¼Œä¿æŒä½ åŸå…ˆâ€œç¼–å·åœ†ç‚¹â€é£æ ¼ï¼‰ */
    .num-marker {
      width: 35px; height: 35px; border-radius: 50%;
      color: white; display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 16px;
      border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
  </style>
</head>

<body>
  <div id="control-panel">
    <h2>ğŸ“ ç½‘ç‚¹è·¯çº¿ä¼˜åŒ–ç³»ç»Ÿï¼ˆç™¾åº¦åœ°å›¾ï¼‰</h2>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('excel')">ğŸ“Š Excelå¯¼å…¥</button>
      <button class="tab" onclick="switchTab('manual')">âœï¸ æ‰‹åŠ¨è¾“å…¥</button>
    </div>

    <div id="excel-tab" class="tab-content active">
      <div class="excel-template">
        <strong>ğŸ“‹ Excelæ ¼å¼è¦æ±‚ï¼š</strong><br>
        åˆ—åï¼š<code>ç»åº¦</code> <code>çº¬åº¦</code> <code>ç½‘ç‚¹åç§°</code> <code>å¤‡æ³¨(å¯é€‰)</code>
      </div>

      <div class="input-group">
        <label>é€‰æ‹©Excelæ–‡ä»¶</label>
        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload()">
      </div>
    </div>

    <div id="manual-tab" class="tab-content">
      <div class="input-group">
        <label>ç½‘ç‚¹æ•°æ®ï¼ˆæ ¼å¼ï¼šç»åº¦,çº¬åº¦,åç§°,å¤‡æ³¨å¯é€‰ï¼‰</label>
        <textarea id="locationInput" rows="8"
          placeholder="116.397428,39.90923,åŒ—äº¬è¥ä¸šéƒ¨,å¤‡æ³¨A
116.404,39.915,æœé˜³æ”¯è¡Œ
116.326,39.989,æµ·æ·€æ”¯è¡Œ,é‡ç‚¹æ‹œè®¿">
116.397428,39.90923,åŒ—äº¬è¥ä¸šéƒ¨,èµ·ç‚¹
116.404,39.915,æœé˜³æ”¯è¡Œ
116.326,39.989,æµ·æ·€æ”¯è¡Œ,é‡ç‚¹æ‹œè®¿
116.368,39.867,ä¸°å°æ”¯è¡Œ
116.481,39.990,é¡ºä¹‰æ”¯è¡Œ
        </textarea>
      </div>
    </div>

    <div class="input-group">
      <label>èµ·å§‹ç½‘ç‚¹ï¼ˆå¯é€‰ï¼šå¡«â€œç½‘ç‚¹åç§°â€åŒ¹é…ï¼‰</label>
      <input type="text" id="startPoint" placeholder="ç•™ç©ºåˆ™é»˜è®¤ä½¿ç”¨ç¬¬1è¡Œä½œä¸ºèµ·ç‚¹ï¼ˆä¼˜åŒ–æ—¶ä¹Ÿå¯è‡ªåŠ¨ï¼‰">
    </div>

    <div>
      <button class="btn btn-primary" onclick="optimizeRoute()">ğŸš€ ä¼˜åŒ–è·¯çº¿</button>
      <button class="btn btn-success" onclick="calculateRoute()">ğŸ“ æŒ‰åºè®¡ç®—</button>
      <button class="btn btn-clear" onclick="clearMap()">ğŸ—‘ï¸ æ¸…é™¤</button>
    </div>

    <div id="route-info"></div>
  </div>

  <div id="container"></div>

  <!-- é…ç½®æ–‡ä»¶ -->
  <script src="/static/config.js"></script>

  <!-- ç™¾åº¦åœ°å›¾JSï¼ˆåŠ è½½å®Œæˆå initMapï¼‰ -->
  <script>
    // æå‰å®šä¹‰ showError å‡½æ•°ï¼Œä¾›åŠ è½½è„šæœ¬ä½¿ç”¨
    function showError(message) {
      const routeInfo = document.getElementById('route-info');
      if (routeInfo) {
        routeInfo.innerHTML = '<div class="error-box">âŒ ' + message + '</div>';
      } else {
        // å¦‚æœå…ƒç´ è¿˜ä¸å­˜åœ¨ï¼Œä½¿ç”¨ alert ä½œä¸ºåå¤‡
        alert('é”™è¯¯ï¼š' + message);
      }
    }

    (function () {
      // ç­‰å¾… config.js åŠ è½½å®Œæˆ
      function waitForConfig(callback, maxAttempts = 50) {
        if (window.BMAP_CONFIG) {
          callback();
          return;
        }
        if (maxAttempts <= 0) {
          showError("é…ç½®æ–‡ä»¶åŠ è½½è¶…æ—¶ï¼è¯·æ£€æŸ¥ static/config.js æ˜¯å¦å­˜åœ¨");
          return;
        }
        setTimeout(() => waitForConfig(callback, maxAttempts - 1), 100);
      }

      waitForConfig(function() {
        const ak = window.BMAP_CONFIG.jsAk;
        if (!ak || ak.includes("æ›¿æ¢")) {
          showError("âš ï¸ è¯·åœ¨ static/config.js ä¸­é…ç½®æœ‰æ•ˆçš„ jsAk");
          console.warn("âš ï¸ è¯·åœ¨ static/config.js ä¸­é…ç½® jsAk");
          return;
        }

        const script = document.createElement("script");
        // ä½¿ç”¨callbackå‚æ•°ç¡®ä¿APIå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
        script.src = "https://api.map.baidu.com/api?v=3.0&ak=" + encodeURIComponent(ak) + "&callback=baiduMapInit";
        script.onerror = function () {
          showError("ç™¾åº¦åœ°å›¾JSåŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š<br>1. jsAkæ˜¯å¦æ­£ç¡®<br>2. åŸŸåç™½åå•/Refereré™åˆ¶<br>3. ç½‘ç»œæ˜¯å¦æ­£å¸¸<br>4. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯");
        };
        document.head.appendChild(script);
      });
    })();
  </script>

  <script>
    let map;
    let markers = [];
    let overlays = []; // label / polyline
    let currentLocations = []; // Excelå¯¼å…¥ç»“æœ

    // å®šä¹‰å…¨å±€å›è°ƒå‡½æ•°ï¼Œä¾›ç™¾åº¦åœ°å›¾APIè°ƒç”¨
    window.baiduMapInit = function() {
      if (typeof BMap !== 'undefined') {
        initMap();
      } else {
        showError("ç™¾åº¦åœ°å›¾APIå¯¹è±¡æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥AKé…ç½®å’Œç½‘ç»œè¿æ¥");
      }
    };

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      if (tabName === 'excel') {
        document.querySelector('.tab:first-child').classList.add('active');
        document.getElementById('excel-tab').classList.add('active');
      } else {
        document.querySelector('.tab:last-child').classList.add('active');
        document.getElementById('manual-tab').classList.add('active');
      }
    }

    function initMap() {
      if (typeof BMap === 'undefined') {
        showError("ç™¾åº¦åœ°å›¾APIæœªåŠ è½½æˆåŠŸ");
        return;
      }
      map = new BMap.Map("container");
      const center = new BMap.Point(116.397428, 39.90923);
      map.centerAndZoom(center, 11);
      map.enableScrollWheelZoom(true);
    }

    function showLoading(message) {
      document.getElementById('route-info').innerHTML =
        '<div class="loading">' + message + '</div>';
    }

    function clearMap() {
      if (!map) return;
      markers.forEach(m => map.removeOverlay(m));
      overlays.forEach(o => map.removeOverlay(o));
      markers = [];
      overlays = [];
      currentLocations = [];
      document.getElementById('route-info').innerHTML = '';
    }

    function parseLocationData() {
      const input = document.getElementById('locationInput').value.trim();
      if (!input) {
        showError('è¯·è¾“å…¥ç½‘ç‚¹æ•°æ®ï¼');
        return [];
      }
      const lines = input.split('\n');
      const locations = [];
      const errors = [];

      lines.forEach((line, idx) => {
        const t = line.trim();
        if (!t) return;
        const parts = t.split(',');
        if (parts.length < 3) {
          errors.push(`ç¬¬${idx + 1}è¡Œï¼šæ ¼å¼é”™è¯¯ï¼ˆè‡³å°‘éœ€è¦ ç»åº¦,çº¬åº¦,åç§°ï¼‰`);
          return;
        }
        const lng = parseFloat(parts[0].trim());
        const lat = parseFloat(parts[1].trim());
        const name = parts[2].trim();
        const remark = parts.slice(3).join(',').trim(); // å¤‡æ³¨å¯å«é€—å·
        if (Number.isNaN(lng) || Number.isNaN(lat)) {
          errors.push(`ç¬¬${idx + 1}è¡Œï¼šç»çº¬åº¦æ ¼å¼é”™è¯¯`);
          return;
        }
        locations.push({ lng, lat, name, remark });
      });

      if (errors.length) {
        showError(errors.join('<br>'));
        return [];
      }
      return locations;
    }

    async function handleExcelUpload() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      if (!file) return;

      showLoading('ğŸ“¤ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const resp = await fetch('/upload_excel', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.error) return showError(data.error);

        currentLocations = data.locations || [];
        document.getElementById('route-info').innerHTML =
          `<div style="padding:10px;background:#4CAF50;color:white;border-radius:5px;">
            âœ… æˆåŠŸå¯¼å…¥ ${currentLocations.length} ä¸ªç½‘ç‚¹
          </div>`;

        // å¡«å……åˆ°æ‰‹åŠ¨æ¡†
        if (currentLocations.length) {
          document.getElementById('locationInput').value =
            currentLocations.map(l => [l.lng, l.lat, l.name, l.remark || ""].filter(x => x !== "").join(',')).join('\n');
        }

        // ä»…ç”»ç‚¹ï¼ˆä¸ç®—è·¯çº¿ï¼‰
        drawPoints(currentLocations);
      } catch (e) {
        showError('ä¸Šä¼ å¤±è´¥ï¼š' + e);
      }
    }

    function colorByIndex(i, total) {
      // æ‰€æœ‰æ ‡è®°ç»Ÿä¸€ä½¿ç”¨äº®è“è‰²
      return '#2196F3';
    }

    function createNumberMarker(point, number, total) {
      // å‚è€ƒ test.html çš„æ–¹å¼åˆ›å»ºåœ†åœˆæ•°å­—æ ‡è¯†
      const markerContent = document.createElement('div');
      const bgColor = colorByIndex(number - 1, total);
      markerContent.style.cssText = `
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: ${bgColor};
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        position: absolute;
        z-index: 10000;
        pointer-events: none;
        cursor: pointer;
      `;
      markerContent.innerHTML = String(number);
      markerContent.setAttribute('data-marker-number', number);

      // ç™¾åº¦åœ°å›¾ä½¿ç”¨è‡ªå®šä¹‰ Icon çš„æ–¹å¼ï¼ˆå ä½ç”¨ï¼‰
      const icon = new BMap.Icon(
        "data:image/svg+xml;base64," + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>`),
        new BMap.Size(1, 1)
      );

      const marker = new BMap.Marker(point, {
        icon,
        offset: new BMap.Size(0, 0),
        enableDragging: false
      });
      marker.setLabel(new BMap.Label('', { offset: new BMap.Size(-9999, -9999) })); // å ä½

      // ä½¿ç”¨DOMè¦†ç›–ç‰©å®ç°åœ†åœˆæ•°å­—æ ‡è¯†ï¼ˆå‚è€ƒ test.html çš„å®ç°æ–¹å¼ï¼‰
      // åˆ›å»ºè‡ªå®šä¹‰ Overlay ç±»
      function NumberMarkerOverlay(point, content) {
        this._point = point;
        this._content = content;
      }
      
      NumberMarkerOverlay.prototype = new BMap.Overlay();
      NumberMarkerOverlay.prototype.initialize = function(map) {
        this._map = map;
        // ä½¿ç”¨ markerPane ç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
        const pane = map.getPanes().markerPane || map.getPanes().labelPane;
        if (pane) {
          pane.appendChild(this._content);
          this._pane = pane;
        }
        return this._content;
      };
      
      NumberMarkerOverlay.prototype.draw = function() {
        if (this._content && this._map) {
          try {
            const pixel = this._map.pointToOverlayPixel(this._point);
            this._content.style.position = 'absolute';
            this._content.style.left = (pixel.x - 17.5) + 'px';
            this._content.style.top = (pixel.y - 17.5) + 'px';
            this._content.style.display = 'flex';
            this._content.style.visibility = 'visible';
            this._content.style.zIndex = '10000';
          } catch(e) {
            console.warn('ç»˜åˆ¶æ ‡è®°å¤±è´¥:', e);
          }
        }
      };
      
      const overlay = new NumberMarkerOverlay(point, markerContent);

      // å…ˆæ·»åŠ  overlayï¼Œç¡®ä¿åœ†åœˆæ•°å­—æ˜¾ç¤º
      map.addOverlay(overlay);
      overlays.push(overlay);
      
      // å¼ºåˆ¶è§¦å‘ä¸€æ¬¡ç»˜åˆ¶ï¼Œç¡®ä¿åœ†åœˆæ•°å­—ç«‹å³æ˜¾ç¤º
      setTimeout(() => {
        if (overlay.draw) {
          overlay.draw();
        }
      }, 100);

      return marker;
    }

    function drawPoints(locations) {
      clearMap();
      if (!map || !locations.length) return;

      const pts = [];
      locations.forEach((loc, idx) => {
        const pt = new BMap.Point(loc.lng, loc.lat);
        pts.push(pt);

        const marker = createNumberMarker(pt, idx + 1, locations.length);
        map.addOverlay(marker);
        markers.push(marker);

        // æ ‡æ³¨ä¿¡æ¯ä½¿ç”¨å¤‡æ³¨å†…å®¹ï¼Œè€Œä¸æ˜¯ç½‘ç‚¹åç§°
        const labelText = loc.remark ? `${idx + 1}. ${loc.remark}` : `${idx + 1}. ${loc.name}`;
        const offsetX = (idx % 2 === 0) ? 30 : -30;
        const offsetY = (idx % 4 < 2) ? -15 : 10;
        const label = new BMap.Label(labelText, { offset: new BMap.Size(offsetX, offsetY) });
        label.setStyle({
          background: 'white',
          border: '2px solid #2196F3',
          padding: '5px 10px',
          borderRadius: '5px',
          fontSize: '13px',
          fontWeight: 'bold',
          boxShadow: '0 2px 6px rgba(0,0,0,0.3)',
          whiteSpace: 'nowrap'
        });
        marker.setLabel(label);

        // åœ°å›¾æ ‡è®°ä¿¡æ¯ä½¿ç”¨å¤‡æ³¨å­—æ®µ
        const infoHtml = `
          <div style="padding:10px;">
            <h4 style="margin:0 0 10px 0;color:#3366FF;">ç¬¬ ${idx + 1} ç«™ï¼š${loc.name}</h4>
            ${loc.remark ? `<p style="margin:5px 0;font-size:14px;color:#FF9800;font-weight:bold;">${loc.remark}</p>` : '<p style="margin:5px 0;font-size:12px;color:#999;">æ— å¤‡æ³¨</p>'}
            <p style="margin:5px 0;font-size:12px;color:#666;">ç»åº¦: ${loc.lng}</p>
            <p style="margin:5px 0;font-size:12px;color:#666;">çº¬åº¦: ${loc.lat}</p>
          </div>`;
        marker.addEventListener('click', () => {
          const win = new BMap.InfoWindow(infoHtml);
          map.openInfoWindow(win, pt);
        });
      });

      map.setViewport(pts);
    }

    function drawRouteResult(result) {
      const { route, polyline, legs, total_distance, total_duration } = result;

      // å…ˆç»˜åˆ¶æ ‡è®°ç‚¹
      drawPoints(route);
      
      // ç¡®ä¿æ ‡è®°ç‚¹ç»˜åˆ¶å®Œæˆåå†ç»˜åˆ¶è·¯çº¿
      setTimeout(() => {
        // å¼ºåˆ¶é‡ç»˜æ‰€æœ‰ overlayï¼Œç¡®ä¿åœ†åœˆæ•°å­—æ˜¾ç¤º
        overlays.forEach(overlay => {
          if (overlay && overlay.draw) {
            try {
              overlay.draw();
            } catch(e) {
              console.warn('é‡ç»˜ overlay å¤±è´¥:', e);
            }
          }
        });
      }, 200);

      if (polyline && polyline.length) {
        const pts = polyline.map(p => new BMap.Point(p[0], p[1]));
        // ä½¿ç”¨äº®è“è‰²æ˜¾ç¤ºè·¯çº¿
        const line = new BMap.Polyline(pts, { strokeWeight: 5, strokeOpacity: 0.9, strokeColor: "#2196F3" });
        map.addOverlay(line);
        overlays.push(line);
        
        // åœ¨è·¯çº¿æ—æ ‡æ³¨è·ç¦»
        if (legs && legs.length > 0) {
          legs.forEach((leg) => {
            if (leg.mid_point && leg.mid_point.length === 2) {
              const midPoint = new BMap.Point(leg.mid_point[0], leg.mid_point[1]);
              const label = new BMap.Label(leg.distance_text, {
                offset: new BMap.Size(10, -10)
              });
              label.setStyle({
                background: 'rgba(255, 152, 0, 0.95)',
                color: 'white',
                border: '2px solid white',
                padding: '5px 10px',
                borderRadius: '5px',
                fontSize: '12px',
                fontWeight: 'bold',
                boxShadow: '0 2px 6px rgba(0,0,0,0.4)',
                whiteSpace: 'nowrap',
                zIndex: 1000
              });
              label.setPosition(midPoint);
              map.addOverlay(label);
              overlays.push(label);
            }
          });
        }
        
        map.setViewport(pts);
      }

      // å·¦ä¾§é¢æ¿ - ä½¿ç”¨ç½‘ç‚¹åç§°å­—æ®µ
      let html = '<h3 style="color:#3366FF;margin-bottom:10px;">ğŸ“‹ è·¯çº¿è¯¦æƒ…</h3>';
      (legs || []).forEach((lg, i) => {
        html += `
          <div class="route-item">
            <strong>${i + 1}. ${lg.from}</strong> â†’ <strong>${i + 2}. ${lg.to}</strong>
            <div class="distance-info">${lg.distance_text} Â· ${lg.duration_text}</div>
          </div>`;
      });
      html += `
        <div style="margin-top:15px;padding:10px;background:#E3F2FD;border-radius:5px;font-weight:bold;">
          <div style="color:#1976D2;">æ€»ç½‘ç‚¹æ•°ï¼š${route.length} ä¸ª</div>
          <div style="color:#FF5722;font-size:16px;margin-top:5px;">
            æ€»è·ç¦»ï¼š${formatMeters(total_distance)} Â· æ€»ç”¨æ—¶ï¼š${formatSeconds(total_duration)}
          </div>
        </div>`;
      document.getElementById('route-info').innerHTML = html;
    }

    function formatMeters(m) {
      if (m >= 1000) return (m / 1000).toFixed(2) + " å…¬é‡Œ";
      return Math.round(m) + " ç±³";
    }
    function formatSeconds(s) {
      s = Math.round(s);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      if (h > 0) return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
      return `${m}åˆ†é’Ÿ`;
    }

    async function calculateRoute() {
      const locations = currentLocations.length ? currentLocations : parseLocationData();
      if (locations.length < 2) return showError('è‡³å°‘éœ€è¦2ä¸ªç½‘ç‚¹ï¼');

      showLoading('ğŸ“ æ­£åœ¨æŒ‰åºè®¡ç®—é©¾è½¦è·¯çº¿...');
      try {
        const resp = await fetch('/calculate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ locations })
        });
        const data = await resp.json();
        if (data.error) return showError(data.error);
        drawRouteResult(data);
      } catch (e) {
        showError('è®¡ç®—å¤±è´¥ï¼š' + e);
      }
    }

    async function optimizeRoute() {
      const locations = currentLocations.length ? currentLocations : parseLocationData();
      if (locations.length < 2) return showError('è‡³å°‘éœ€è¦2ä¸ªç½‘ç‚¹ï¼');

      const startName = document.getElementById('startPoint').value.trim() || null;
      showLoading('ğŸ”„ æ­£åœ¨ä¼˜åŒ–é¡ºåºå¹¶è§„åˆ’é©¾è½¦è·¯çº¿...');

      try {
        const resp = await fetch('/optimize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ locations, start_name: startName })
        });
        const data = await resp.json();
        if (data.error) return showError(data.error);
        drawRouteResult(data);
      } catch (e) {
        showError('ä¼˜åŒ–å¤±è´¥ï¼š' + e);
      }
    }
  </script>
</body>
</html>