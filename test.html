<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç‚¹è·¯çº¿ä¼˜åŒ–ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "PingFang SC", Arial, sans-serif;
        }
        
        #container {
            width: 100%;
            height: 100vh;
        }
        
        #control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 380px;
            z-index: 1000;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 13px;
        }
        
        textarea, input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
            font-family: inherit;
        }
        
        textarea {
            resize: vertical;
        }
        
        input[type="file"] {
            padding: 8px;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px 5px 5px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3366FF;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2850CC;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388E3C;
        }
        
        .btn-upload {
            background: #9C27B0;
            color: white;
        }
        
        .btn-upload:hover {
            background: #7B1FA2;
        }
        
        .btn-clear {
            background: #9E9E9E;
            color: white;
        }
        
        .btn-clear:hover {
            background: #757575;
        }
        
        #route-info {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .route-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-left: 4px solid #3366FF;
            border-radius: 3px;
        }
        
        .distance-info {
            color: #FF5722;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 10px;
        }
        
        .tip-box {
            background: #E3F2FD;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #1976D2;
            border-left: 4px solid #2196F3;
        }
        
        .error-box {
            background: #FFEBEE;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #C62828;
            border-left: 4px solid #F44336;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #3366FF;
            border-bottom: 3px solid #3366FF;
            margin-bottom: -2px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .excel-template {
            background: #E3F2FD;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .excel-template code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="control-panel">
        <h2>ğŸ“ ç½‘ç‚¹è·¯çº¿ä¼˜åŒ–ç³»ç»Ÿ</h2>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('excel')">ğŸ“Š Excelå¯¼å…¥</button>
            <button class="tab" onclick="switchTab('manual')">âœï¸ æ‰‹åŠ¨è¾“å…¥</button>
        </div>
        
        <!-- Excelå¯¼å…¥æ ‡ç­¾é¡µ -->
        <div id="excel-tab" class="tab-content active">
            <div class="excel-template">
                <strong>ğŸ“‹ Excelæ ¼å¼è¦æ±‚ï¼š</strong><br>
                åˆ—åï¼š<code>ç»åº¦</code> <code>çº¬åº¦</code> <code>ç½‘ç‚¹åç§°</code>
            </div>
            
            <div class="input-group">
                <label>é€‰æ‹©Excelæ–‡ä»¶</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload()">
            </div>
        </div>
        
        <!-- æ‰‹åŠ¨è¾“å…¥æ ‡ç­¾é¡µ -->
        <div id="manual-tab" class="tab-content">
            <div class="input-group">
                <label>ç½‘ç‚¹æ•°æ®ï¼ˆæ ¼å¼ï¼šç»åº¦,çº¬åº¦,åç§°ï¼‰</label>
                <textarea id="locationInput" rows="8" placeholder="116.397428,39.90923,åŒ—äº¬è¥ä¸šéƒ¨
116.404,39.915,æœé˜³æ”¯è¡Œ
116.326,39.989,æµ·æ·€æ”¯è¡Œ">116.397428,39.90923,åŒ—äº¬è¥ä¸šéƒ¨
116.404,39.915,æœé˜³æ”¯è¡Œ
116.326,39.989,æµ·æ·€æ”¯è¡Œ
116.368,39.867,ä¸°å°æ”¯è¡Œ
116.481,39.990,é¡ºä¹‰æ”¯è¡Œ</textarea>
            </div>
        </div>
        
        <div class="input-group">
            <label>èµ·å§‹ç½‘ç‚¹ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="startPoint" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜èµ·ç‚¹">
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="optimizeRoute()">ğŸš€ ä¼˜åŒ–è·¯çº¿</button>
            <button class="btn btn-success" onclick="calculateRoute()">ğŸ“ æŒ‰åºè®¡ç®—</button>
            <button class="btn btn-clear" onclick="clearMap()">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>
        
        <div id="route-info"></div>
    </div>
    
    <div id="container"></div>

    <!-- å¼•å…¥APIé…ç½®æ–‡ä»¶ -->
    <script src="/static/config.js"></script>
    
    <script>
        // é…ç½®å®‰å…¨å¯†é’¥ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        if (window.AMAP_CONFIG && window.AMAP_CONFIG.securityJsCode) {
            window._AMapSecurityConfig = {
                securityJsCode: window.AMAP_CONFIG.securityJsCode
            };
        }
    </script>
    
    <!-- åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾API -->
    <script>
        (function() {
            if (!window.AMAP_CONFIG) {
                alert('é”™è¯¯ï¼šé…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼\nè¯·æ£€æŸ¥ static/config.js æ˜¯å¦å­˜åœ¨');
                return;
            }
            
            if (window.AMAP_CONFIG.key === 'è¯·æ›¿æ¢ä¸ºä½ çš„é«˜å¾·API_Key') {
                console.error('âš ï¸ è¯·åœ¨ static/config.js ä¸­é…ç½®ä½ çš„é«˜å¾·API Key');
            }
            
            var script = document.createElement('script');
            script.src = 'https://webapi.amap.com/maps?v=' + window.AMAP_CONFIG.version + '&key=' + window.AMAP_CONFIG.key + '&plugin=AMap.Scale,AMap.ToolBar';
            script.onerror = function() {
                alert('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼\nè¯·æ£€æŸ¥ï¼š\n1. API Keyæ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. ç™½åå•æ˜¯å¦é…ç½®ï¼ˆlocalhost, 127.0.0.1ï¼‰');
            };
            script.onload = function() {
                console.log('âœ… é«˜å¾·åœ°å›¾APIåŠ è½½å®Œæˆ');
            };
            document.head.appendChild(script);
        })();
    </script>
    
    <script>
        var map;
        var markers = [];
        var polylines = [];
        var labels = [];
        var currentLocations = [];

        // ç­‰å¾…é«˜å¾·åœ°å›¾APIåŠ è½½å®Œæˆ
        function initMap() {
            if (typeof AMap === 'undefined') {
                showError('åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š<br>1. API Keyæ˜¯å¦æ­£ç¡®<br>2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>3. ç™½åå•æ˜¯å¦é…ç½®');
                return;
            }

            try {
                map = new AMap.Map('container', {
                    zoom: 11,
                    center: [116.397428, 39.90923],
                    viewMode: '2D'
                });

                // å®‰å…¨åœ°æ·»åŠ æ§ä»¶ï¼Œå¦‚æœæ§ä»¶ä¸å­˜åœ¨åˆ™è·³è¿‡
                try {
                    if (AMap.Scale) {
                        map.addControl(new AMap.Scale());
                    }
                } catch(e) {
                    console.warn('Scaleæ§ä»¶åŠ è½½å¤±è´¥:', e);
                }

                try {
                    if (AMap.ToolBar) {
                        map.addControl(new AMap.ToolBar({ position: 'RB' }));
                    }
                } catch(e) {
                    console.warn('ToolBaræ§ä»¶åŠ è½½å¤±è´¥:', e);
                }
                
                console.log('âœ… åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
            } catch(e) {
                showError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š' + e.message + '<br>è¯·æ£€æŸ¥API Keyé…ç½®');
                console.error('åœ°å›¾åˆå§‹åŒ–é”™è¯¯:', e);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tabName === 'excel') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('excel-tab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('manual-tab').classList.add('active');
            }
        }

        function handleExcelUpload() {
            var fileInput = document.getElementById('excelFile');
            var file = fileInput.files[0];
            
            if (!file) return;
            
            document.getElementById('route-info').innerHTML = '<div class="loading">ğŸ“¤ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>';
            
            var formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload_excel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    currentLocations = data.locations;
                    document.getElementById('route-info').innerHTML = 
                        `<div style="padding: 10px; background: #4CAF50; color: white; border-radius: 5px;">
                            âœ… æˆåŠŸå¯¼å…¥ ${currentLocations.length} ä¸ªç½‘ç‚¹
                        </div>`;
                    
                    // å°†å¯¼å…¥çš„æ•°æ®å¡«å……åˆ°æ‰‹åŠ¨è¾“å…¥æ¡†ä¸­
                    if (currentLocations.length > 0) {
                        var manualInputText = currentLocations.map(function(loc) {
                            return loc.lng + ',' + loc.lat + ',' + loc.name;
                        }).join('\n');
                        document.getElementById('locationInput').value = manualInputText;
                        console.log('âœ… æ•°æ®å·²å¡«å……åˆ°æ‰‹åŠ¨è¾“å…¥æ¡†');
                    }
                    
                    // è‡ªåŠ¨åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå¯¼å…¥çš„ç½‘ç‚¹
                    console.log('âœ… å¯¼å…¥æˆåŠŸï¼Œç½‘ç‚¹æ•°é‡:', currentLocations.length);
                    console.log('åœ°å›¾å¯¹è±¡çŠ¶æ€:', map ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
                    
                    if (currentLocations.length > 0 && map) {
                        try {
                            console.log('å¼€å§‹åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºç½‘ç‚¹...');
                            drawRoute(currentLocations);
                            console.log('âœ… ç½‘ç‚¹å·²æ˜¾ç¤ºåœ¨åœ°å›¾ä¸Š');
                            
                            // è°ƒæ•´åœ°å›¾è§†é‡ä»¥æ˜¾ç¤ºæ‰€æœ‰ç½‘ç‚¹
                            if (currentLocations.length > 0) {
                                var bounds = new AMap.Bounds();
                                currentLocations.forEach(function(loc) {
                                    bounds.extend([loc.lng, loc.lat]);
                                });
                                map.setBounds(bounds, false, [50, 50, 50, 50]);
                                console.log('âœ… åœ°å›¾è§†é‡å·²è°ƒæ•´');
                            }
                        } catch(e) {
                            console.error('âŒ æ˜¾ç¤ºç½‘ç‚¹å¤±è´¥:', e);
                            showError('ç½‘ç‚¹å·²å¯¼å…¥ï¼Œä½†åœ°å›¾æ˜¾ç¤ºå¤±è´¥ï¼š' + e.message);
                        }
                    } else if (!map) {
                        console.warn('âš ï¸ åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ˜¾ç¤ºç½‘ç‚¹');
                        showError('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    } else if (currentLocations.length === 0) {
                        console.warn('âš ï¸ å¯¼å…¥çš„ç½‘ç‚¹æ•°æ®ä¸ºç©º');
                    }
                }
            })
            .catch(error => {
                showError('ä¸Šä¼ å¤±è´¥ï¼š' + error);
            });
        }

        function parseLocationData() {
            var input = document.getElementById('locationInput').value.trim();
            if (!input) {
                showError('è¯·è¾“å…¥ç½‘ç‚¹æ•°æ®ï¼');
                return [];
            }
            
            var lines = input.split('\n');
            var locations = [];
            var errors = [];
            
            lines.forEach(function(line, index) {
                if (line.trim()) {
                    var parts = line.split(',');
                    if (parts.length >= 3) {
                        var lng = parseFloat(parts[0].trim());
                        var lat = parseFloat(parts[1].trim());
                        var name = parts.slice(2).join(',').trim();
                        
                        if (isNaN(lng) || isNaN(lat)) {
                            errors.push('ç¬¬' + (index+1) + 'è¡Œï¼šç»çº¬åº¦æ ¼å¼é”™è¯¯');
                        } else {
                            locations.push({ lng: lng, lat: lat, name: name });
                        }
                    } else {
                        errors.push('ç¬¬' + (index+1) + 'è¡Œï¼šæ ¼å¼é”™è¯¯');
                    }
                }
            });
            
            if (errors.length > 0) {
                showError(errors.join('<br>'));
                return [];
            }
            
            return locations;
        }

        function showError(message) {
            document.getElementById('route-info').innerHTML = 
                '<div class="error-box">âŒ ' + message + '</div>';
        }

        function calculateDistance(point1, point2) {
            try {
                return AMap.GeometryUtil.distance(
                    new AMap.LngLat(point1.lng, point1.lat),
                    new AMap.LngLat(point2.lng, point2.lat)
                );
            } catch(e) {
                return 0;
            }
        }

        function formatDistance(meters) {
            if (meters >= 1000) {
                return (meters / 1000).toFixed(2) + ' å…¬é‡Œ';
            } else {
                return meters.toFixed(0) + ' ç±³';
            }
        }

        function clearMap() {
            markers.forEach(marker => map.remove(marker));
            polylines.forEach(line => map.remove(line));
            labels.forEach(label => map.remove(label));
            markers = [];
            polylines = [];
            labels = [];
            currentLocations = [];
            document.getElementById('route-info').innerHTML = '';
        }

        function getMidPoint(point1, point2) {
            return [(point1.lng + point2.lng) / 2, (point1.lat + point2.lat) / 2];
        }

        function createNumberedMarker(location, number, total) {
            var markerContent = document.createElement('div');
            markerContent.style.cssText = `
                width: 35px;
                height: 35px;
                border-radius: 50%;
                background: ${number === 1 ? '#4CAF50' : number === total ? '#FF5722' : '#3366FF'};
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 16px;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            `;
            markerContent.innerHTML = number;
            
            return new AMap.Marker({
                position: [location.lng, location.lat],
                content: markerContent,
                offset: new AMap.Pixel(-17.5, -17.5),
                title: location.name
            });
        }

        function drawRoute(locations) {
            clearMap();
            var totalDistance = 0;
            
            locations.forEach(function(loc, index) {
                var number = index + 1;
                
                var marker = createNumberedMarker(loc, number, locations.length);
                map.add(marker);
                markers.push(marker);
                
                // æ™ºèƒ½åç§»é¿å…é‡å 
                var offsetX, offsetY;
                switch(number % 4) {
                    case 1: offsetX = 30; offsetY = -15; break;
                    case 2: offsetX = 30; offsetY = 10; break;
                    case 3: offsetX = -30; offsetY = -15; break;
                    case 0: offsetX = -30; offsetY = 10; break;
                }
                
                var nameLabel = new AMap.Text({
                    text: `${number}. ${loc.name}`,
                    position: [loc.lng, loc.lat],
                    offset: new AMap.Pixel(offsetX, offsetY),
                    style: {
                        'background': 'white',
                        'border': '2px solid #3366FF',
                        'padding': '5px 10px',
                        'border-radius': '5px',
                        'font-size': '13px',
                        'font-weight': 'bold',
                        'box-shadow': '0 2px 6px rgba(0,0,0,0.3)',
                        'white-space': 'nowrap'
                    }
                });
                map.add(nameLabel);
                labels.push(nameLabel);
                
                if (index > 0) {
                    var prevLoc = locations[index - 1];
                    var polyline = new AMap.Polyline({
                        path: [[prevLoc.lng, prevLoc.lat], [loc.lng, loc.lat]],
                        strokeColor: '#3366FF',
                        strokeWeight: 5,
                        strokeOpacity: 0.8,
                        showDir: true,
                        dirColor: '#FF5722'
                    });
                    map.add(polyline);
                    polylines.push(polyline);
                    
                    var distance = calculateDistance(prevLoc, loc);
                    totalDistance += distance;
                    
                    var midPoint = getMidPoint(prevLoc, loc);
                    var distanceLabel = new AMap.Text({
                        text: formatDistance(distance),
                        position: midPoint,
                        style: {
                            'background': '#FFF9C4',
                            'border': '2px solid #FFA000',
                            'padding': '4px 8px',
                            'border-radius': '3px',
                            'font-size': '12px',
                            'color': '#F57C00',
                            'font-weight': 'bold'
                        }
                    });
                    map.add(distanceLabel);
                    labels.push(distanceLabel);
                }
                
                marker.on('click', function() {
                    var infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h4 style="margin: 0 0 10px 0; color: #3366FF;">
                                    ç¬¬ ${number} ç«™ï¼š${loc.name}
                                </h4>
                                <p style="margin: 5px 0; font-size: 12px;">ç»åº¦: ${loc.lng}</p>
                                <p style="margin: 5px 0; font-size: 12px;">çº¬åº¦: ${loc.lat}</p>
                                ${index > 0 ? `<p style="margin: 5px 0; font-size: 12px; color: #FF5722;">
                                    è·ä¸Šä¸€ç«™: ${formatDistance(calculateDistance(locations[index-1], loc))}
                                </p>` : '<p style="margin: 5px 0; font-size: 12px; color: #4CAF50;">èµ·ç‚¹</p>'}
                            </div>
                        `
                    });
                    infoWindow.open(map, marker.getPosition());
                });
            });
            
            displayRouteInfo(locations, totalDistance);
            map.setFitView();
        }

        function displayRouteInfo(locations, totalDistance) {
            var html = '<h3 style="color: #3366FF; margin-bottom: 10px;">ğŸ“‹ è·¯çº¿è¯¦æƒ…</h3>';
            
            locations.forEach(function(loc, index) {
                if (index > 0) {
                    var distance = calculateDistance(locations[index-1], loc);
                    html += `
                        <div class="route-item">
                            <strong>${index}. ${locations[index-1].name}</strong> 
                            â†’ <strong>${index+1}. ${loc.name}</strong>
                            <div class="distance-info">${formatDistance(distance)}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="route-item" style="border-left-color: #4CAF50;">
                            <strong>ğŸš© èµ·ç‚¹ï¼š1. ${loc.name}</strong>
                        </div>
                    `;
                }
            });
            
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #E3F2FD; border-radius: 5px; font-weight: bold;">
                    <div style="color: #1976D2;">æ€»ç½‘ç‚¹æ•°ï¼š${locations.length} ä¸ª</div>
                    <div style="color: #FF5722; font-size: 16px; margin-top: 5px;">
                        æ€»è·ç¦»ï¼š${formatDistance(totalDistance)}
                    </div>
                </div>
            `;
            
            document.getElementById('route-info').innerHTML = html;
        }

        function optimizeRoute() {
            var locations = currentLocations.length > 0 ? currentLocations : parseLocationData();
            
            if (locations.length < 2) {
                showError('è‡³å°‘éœ€è¦2ä¸ªç½‘ç‚¹ï¼');
                return;
            }
            
            var startName = document.getElementById('startPoint').value.trim();
            
            document.getElementById('route-info').innerHTML = '<div class="loading">ğŸ”„ æ­£åœ¨ä¼˜åŒ–è·¯çº¿...</div>';
            
            fetch('/optimize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    locations: locations,
                    start_name: startName || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    drawRoute(data.route);
                }
            })
            .catch(error => {
                showError('ä¼˜åŒ–å¤±è´¥ï¼š' + error);
            });
        }

        function calculateRoute() {
            var locations = currentLocations.length > 0 ? currentLocations : parseLocationData();
            
            if (locations.length < 2) {
                showError('è‡³å°‘éœ€è¦2ä¸ªç½‘ç‚¹ï¼');
                return;
            }
            
            drawRoute(locations);
        }

        // ç­‰å¾…åœ°å›¾APIåŠ è½½å®Œæˆ
        function waitForAMap(callback, maxAttempts) {
            maxAttempts = maxAttempts || 50; // æœ€å¤šå°è¯•50æ¬¡ï¼Œçº¦5ç§’
            var attempts = 0;
            
            function check() {
                attempts++;
                if (typeof AMap !== 'undefined' && AMap.Map) {
                    console.log('âœ… AMap APIå·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾');
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                } else {
                    showError('é«˜å¾·åœ°å›¾APIåŠ è½½è¶…æ—¶ï¼<br><br>è¯·æ£€æŸ¥ï¼š<br>' +
                             '1. API Keyæ˜¯å¦æ­£ç¡®å¡«å†™<br>' +
                             '2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>' +
                             '3. ç™½åå•æ˜¯å¦æ·»åŠ ï¼ˆlocalhost, 127.0.0.1ï¼‰<br>' +
                             '4. æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†é”™è¯¯');
                }
            }
            check();
        }

        window.onload = function() {
            waitForAMap(function() {
                try {
                    initMap();
                } catch(error) {
                    showError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message + '<br>è¯·æŒ‰F12æŸ¥çœ‹è¯¦ç»†é”™è¯¯');
                    console.error('è¯¦ç»†é”™è¯¯ï¼š', error);
                }
            });
        };
    </script>
</body>
</html>
